<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nature Clock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="site.webmanifest" />
    <style>
        :root {
            --arabic-font: 'Amiri', serif;
        }

	
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            overflow: hidden;
            position: relative;
            transition: background 1s ease;
        }

        /* Background container with blur */
        .background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(15px) brightness(0.8);
            transform: scale(1.05);
            transition: opacity 1.5s ease-in-out, transform 1.5s ease-in-out;
            z-index: -1;
        }

        .background.transition-fade {
            transition: opacity 1.5s ease-in-out;
        }

        .background.transition-slide {
            transition: transform 1.5s ease-in-out;
        }

        .background.transition-zoom {
            transition: transform 1.5s ease-in-out, opacity 1.5s ease-in-out;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            z-index: -1;
        }

        /* Main glass container */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 
                        inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            padding: 40px;
            width: 90%;
            max-width: 550px;
            text-align: center;
            position: relative;
            /* overflow: hidden; */ /* Replaced with overflow-y: hidden for auto-layout */
            transition: all 0.4s ease;
        }

        body.dark-mode .glass-container {
            background: rgba(30, 30, 40, 0.25);
        }

        /* Glass effect inner elements */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            margin: 20px 0;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1),
                        0 5px 15px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .glass {
            background: rgba(0, 0, 0, 0.25);
        }

        /* Header styling */
        .header {
            margin-bottom: 30px;
            position: relative;
        }

        .title {
            font-size: 2.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        body.dark-mode .title {
            color: #f0f0f0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            max-width: 90%;
            margin: 0 auto;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        body.dark-mode .subtitle {
            color: rgba(255, 255, 255, 0.9);
        }

        .arabic-text {
            font-size: 1.8rem; /* Slightly larger for better readability */
            font-family: var(--arabic-font);
            line-height: 1.8; /* More spacing between lines */
            text-rendering: optimizeLegibility; /* Better diacritic handling */
            font-feature-settings: "calt" 1; /* Contextual alternates */
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.95); /* Better contrast */
        }

        .content-ref {
            color: #f8f8f8;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px dotted rgba(255, 255, 255, 0.5);
            margin-left: 8px;
        }

        .content-ref:hover {
            color: #4facfe;
            border-bottom: 1px dotted #4facfe;
        }

        /* Clock styling */
        .clock-container {
            margin: 25px 0;
        }

        .clock {
            font-size: 5.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            margin: 20px 0;
            letter-spacing: 3px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 10px 20px;
            display: inline-block;
        }

        body.dark-mode .clock {
            background: rgba(0, 0, 0, 0.3);
        }

        .date, .islamic-date {
            font-size: 1.4rem;
            color: rgba(255, 255, 255, 0.85);
            margin-top: 10px;
            font-weight: 500;
        }

        .islamic-date {
             font-size: 1.2rem;
        }

        /* Timer buttons */
        .timer-section {
            margin: 30px 0;
        }

        .timer-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .timer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 14px 25px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            min-width: 90px;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .timer-btn {
            background: rgba(0, 0, 0, 0.3);
        }

        .timer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
        }

        .timer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .timer-btn:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .timer-btn:active {
            transform: translateY(1px);
        }

        /* Timer display */
        .timer-display {
            font-size: 2.8rem;
            font-weight: 700;
            color: white;
            margin: 30px 0;
            min-height: 70px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* Control buttons */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            transition: opacity 0.5s ease;
            position: relative; /* Added */
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        body.dark-mode .control-btn {
            background: rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .control-btn:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .control-btn:active {
            transform: translateY(1px);
        }

        /* NEW: styles for the plus button in control area */
        .controls .timer-toggle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
        }

        .controls .timer-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .controls .timer-toggle.expanded {
            width: 180px;
            border-radius: 50px;
        }

        .controls .timer-toggle .custom-timer-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .controls .timer-toggle.expanded .custom-timer-input {
            opacity: 1;
            pointer-events: all;
        }

        .controls .timer-toggle .custom-timer-input input {
            background: transparent;
            border: none;
            width: 100%;
            height: 100%;
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 0 20px;
            outline: none;
        }

        /* BUG FIX: Hide plus icon when expanded */
        .controls .timer-toggle i {
            transition: opacity 0.2s ease;
        }

        .controls .timer-toggle.expanded i {
            opacity: 0;
            pointer-events: none;
        }


        /* Top control buttons */
        .top-controls {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 15px;
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        .top-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        body.dark-mode .top-btn {
            background: rgba(0, 0, 0, 0.3);
        }

        .top-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        body.dark-mode .top-btn:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 1.1rem;
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 100;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Footer */
        .footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            padding: 15px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
        }

        .settings-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .settings-content {
            background: rgba(30, 30, 40, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            background: rgba(30, 30, 40, 0.9);
            z-index: 10;
            padding: 10px 0;
            backdrop-filter: blur(10px);
        }

        .settings-title {
            font-size: 2.2rem;
            color: white;
            font-weight: 600;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-settings {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            position: sticky;
            top: 10px;
            z-index: 11;
            backdrop-filter: blur(5px);
        }

        .close-settings:hover {
            background: rgba(255, 50, 50, 0.3);
            transform: rotate(90deg);
        }

        .settings-footer {
            position: sticky;
            bottom: 0;
            background: rgba(30, 30, 40, 0.9);
            padding: 15px 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .settings-group {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-group:last-child {
            border-bottom: none;
        }

        .group-title {
            font-size: 1.4rem;
            color: #4facfe;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        
        details.setting-item {
            display: block;
            padding: 0;
        }

        details > summary {
            padding: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 400;
            color: white;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        details > summary::-webkit-details-marker {
            display: none;
        }

        details > summary::after {
            content: '\f078';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            transition: transform 0.3s ease;
        }

        details[open] > summary::after {
            transform: rotate(180deg);
        }

        .setting-label {
            color: white;
            font-size: 1.1rem;
            font-weight: 400;
            flex: 1;
            text-align: left;
        }
        
        /* Fix for slider container width */
        .setting-control {
            flex: 1;
            display: flex;
            justify-content: flex-end;
        }

        .setting-value {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            text-align: right;
        }

        select, input[type="text"], input[type="number"], input[type="file"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 15px;
            color: white;
            font-size: 1rem;
            width: 100%;
            max-width: 200px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
        }

        .checkbox-label {
            margin-left: 10px;
            color: white;
        }

        .test-sound-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .test-sound-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* --- NEW SLIDER LAYOUT --- */
        .slider-group-container {
            padding: 0 15px 15px;
        }
        .slider-group {
            margin-top: 20px;
        }
        .slider-group .setting-label {
            margin-bottom: 15px;
            text-align: left;
        }
        .slider-group .setting-control {
            width: 100%;
            min-width: unset;
            flex-basis: auto;
        }
        
        /* Slider adjustments - FIX */
        .slider-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 10px 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            margin-top: 8px;
        }

        .slider-labels span {
            position: relative;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .slider-labels span::before {
            content: '';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.4);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            outline: none;
            margin: 0;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: -8px; /* Center thumb on track */
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #00f2fe;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
        }


        /* Custom file input */
        .custom-file-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .custom-file-label {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .custom-file-label:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Subreddit management */
        .subreddit-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .subreddit-list {
            max-height: 100px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        .subreddit-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .subreddit-item:last-child {
            border-bottom: none;
        }

        .subreddit-name {
            color: white;
        }

        .remove-subreddit {
            color: #ff6b6b;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1rem;
        }

        .add-subreddit {
            display: flex;
            gap: 10px;
        }

        .add-subreddit input {
            flex: 1;
            padding: 8px 12px;
        }

        .add-subreddit button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-subreddit button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .glass-container { padding: 25px; width: 95%; }
            .clock { font-size: 4rem; padding: 8px 15px; }
            .date, .islamic-date { font-size: 1.2rem; }
            .title { font-size: 2.2rem; }
            .timer-buttons { gap: 10px; }
            .timer-btn { padding: 12px 20px; font-size: 1rem; min-width: 80px; }
            .timer-display { font-size: 2.2rem; }
            .control-btn { width: 60px; height: 60px; font-size: 1.5rem; }
            .top-btn { width: 50px; height: 50px; font-size: 1.3rem; }
            .settings-content { padding: 25px; }
            .setting-item, .slider-group { flex-direction: column; align-items: flex-start; }
            .setting-control { margin-top: 15px; width: 100%; justify-content: flex-start; min-width: unset; }
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Add this new CSS rule for the auto-mode icon */
        .auto-mode-icon {
            font-weight: bold;
            font-size: 1.3em;
        }

        /* --- MODIFIED: Final responsive scaling for auto layout --- */
        .glass-container.auto-layout {
            width: min(90vw, 90vh);
            max-width: 800px;
            max-height: 95vh;
            /* Hide the scrollbar by default */
            overflow-y: hidden;
            padding: clamp(20px, 3vmin, 40px);
        }

        @media (orientation: portrait) {
            .glass-container.auto-layout {
                width: 95vw;
                max-width: 550px;
                max-height: 90vh;
            }
        }

        .glass-container.auto-layout .title {
            font-size: clamp(2rem, 3.5vmin, 2.8rem);
        }

        .glass-container.auto-layout .clock {
            font-size: clamp(3.5rem, 8vmin, 5.5rem);
        }

        .glass-container.auto-layout .date, 
        .glass-container.auto-layout .islamic-date {
            font-size: clamp(1rem, 1.8vmin, 1.4rem);
        }

        .glass-container.auto-layout .timer-display {
             font-size: clamp(2rem, 4vmin, 2.8rem);
        }

        /* Make margins responsive ONLY in auto-layout mode to prevent overflow */
        .glass-container.auto-layout .header {
            margin-bottom: clamp(15px, 2vmin, 30px);
        }

        .glass-container.auto-layout .clock-container {
            margin: clamp(15px, 2vmin, 25px) 0;
        }

        .glass-container.auto-layout .timer-section {
            margin: clamp(15px, 2vmin, 30px) 0 0 0; /* Remove bottom margin */
        }
        .arabic-text {
          font-size: 1.8rem;
          /* Swap in whichever you chose above: */
          font-family: var(--arabic-font);
          /* or: font-family: var(--arabic-font); */
          line-height: 1.8;
          text-rendering: optimizeLegibility;
          font-feature-settings: "calt" 1;
          margin-bottom: 15px;
          /* Use a solid color—no reds: */
          color: #ffffff; /* or rgba(255,255,255,0.95) */
        }

        /* Add new styles for combined timer button */
        .timer-toggle {
            position: relative;
            width: 80px;
            transition: width 0.3s ease;
        }
        
        .timer-toggle.expanded {
            width: 180px;
        }
        
        .custom-timer-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .timer-toggle.expanded .custom-timer-input {
            opacity: 1;
            pointer-events: all;
        }
        
        .custom-timer-input input {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 14px 15px;
            color: white;
            width: 100%;
            font-size: 1rem;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        
        .custom-timer-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Stopwatch styles */
        .stopwatch-display {
            font-size: 2.8rem;
            font-weight: 700;
            color: white;
            margin: 30px 0;
            min-height: 70px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            font-variant-numeric: tabular-nums;
        }
        
        .milliseconds {
            font-size: 1.5rem;
            vertical-align: baseline;
        }
        
        /* DEPRECATED STYLE - HIDE OLD BUTTON */
        .timer-btn#stopwatchToggleBtn {
            display: none; 
        }

        /* NEW: Active state for stopwatch button */
        .control-btn.active {
            background: rgba(255, 255, 255, 0.4);
        }

        body.dark-mode .control-btn.active {
            background: rgba(0, 0, 0, 0.5);
        }

    </style>
</head>
<body>
    <div class="background-container">
        <div class="background" id="background"></div>
        <div class="overlay"></div>
    </div>
    <div class="glass-container" id="glassContainer">
        <div class="top-controls" id="topControls"><button class="top-btn" id="muteBtn"><i class="fas fa-volume-up"></i></button><button class="top-btn" id="darkModeBtn"><i class="fas fa-moon"></i></button><button class="top-btn" id="settingsBtn"><i class="fas fa-cog"></i></button></div>
        <div class="header"><h1 class="title">Nature Clock</h1><div class="subtitle" id="subtitle"></div></div>
        <div class="clock-container"><div class="glass"><div class="clock" id="clock"></div><div class="date" id="date"></div><div class="islamic-date" id="islamicDate"></div></div></div>
        <div class="timer-section">
            <div class="glass">
                <div class="timer-display" id="timerDisplay">Set a timer</div>
                <div class="stopwatch-display" id="stopwatchDisplay" style="display: none;">00:00:00</div>
                <div class="timer-buttons">
                    <button class="timer-btn" data-minutes="5">5 Min</button>
                    <button class="timer-btn" data-minutes="10">10 Min</button>
                    <button class="timer-btn" data-minutes="15">15 Min</button>
                    <button class="timer-btn" data-minutes="30">30 Min</button>
                    <button class="timer-btn" id="stopwatchToggleBtn" style="display: none;">
                        <i class="fas fa-stopwatch"></i>
                    </button>
                </div>
                <div class="controls" id="timerControls">
                    <div class="timer-toggle" id="customTimerContainer">
                        <div class="custom-timer-input">
                            <input type="number" id="customMinutes" min="1" placeholder="Mins" onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                        </div>
                        <i class="fas fa-plus"></i>
                    </div>
                    <button class="control-btn" id="toggleTimerBtn"><i class="fas fa-play"></i></button>
                    <button class="control-btn" id="resetBtn"><i class="fas fa-redo"></i></button>
                    <button class="control-btn" id="stopwatchControlBtn"><i class="fas fa-stopwatch"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div class="footer" id="footer">Backgrounds from r/EarthPorn, r/NaturePorn & r/LandscapePhotography</div>
    <div class="toast" id="toast"></div>
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header"><h2 class="settings-title">Clock Settings</h2><button class="close-settings" id="closeSettings"><i class="fas fa-times"></i></button></div>
            <div class="settings-group">
                <h3 class="group-title">Display Settings</h3>
                <div class="setting-item">
                    <div class="setting-label">Arabic Font</div>
                    <div class="setting-control">
                        <select id="arabicFont">
                            <option value="'Amiri', serif">Amiri (Traditional)</option>
                            <option value="'Noto Naskh Arabic', serif">Noto Naskh (Modern)</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item"><div class="setting-label">Show clock Seconds</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="showSeconds"><label class="checkbox-label" for="showSeconds"></label></div></div></div>
                <div class="setting-item"><div class="setting-label">Show stopwatch milliseconds</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="showMilliseconds"><label class="checkbox-label" for="showMilliseconds"></label></div></div></div>
                <div class="setting-item"><div class="setting-label">Show Islamic Calendar</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="showIslamicDate" checked><label class="checkbox-label" for="showIslamicDate"></label></div></div></div>
                <div class="setting-item"><div class="setting-label">Show Loading Text</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="showLoading"><label class="checkbox-label" for="showLoading"></label></div></div></div>
                <div class="setting-item"><div class="setting-label">Show Sources in Footer</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="showSources"><label class="checkbox-label" for="showSources"></label></div></div></div>
                <div class="setting-item"><div class="setting-label">Time Format</div><div class="setting-control"><select id="timeFormat"><option value="24h">24-Hour Format</option><option value="12h" selected>12-Hour Format</option></select></div></div>
                <div class="setting-item"><div class="setting-label">Auto-Hide Controls</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="autoHideControls" checked><label class="checkbox-label" for="autoHideControls"></label></div></div></div>
                <div class="setting-item"><div class="setting-label">Layout Mode</div><div class="setting-control"><select id="layoutMode"><option value="auto">Auto</option><option value="landscape">Landscape</option><option value="portrait">Portrait</option></select></div></div>
            </div>
            <div class="settings-group">
                <h3 class="group-title">Theme Settings</h3>
                <div class="setting-item">
                    <div class="setting-label">Theme Mode</div>
                    <div class="setting-control">
                        <select id="themeMode">
                            <option value="auto" selected>Auto</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Auto Mode Source</div>
                    <div class="setting-control">
                        <select id="autoLocationMode">
                            <option value="basic">Basic (6am-6pm)</option>
                            <option value="ip" selected>IP Address</option>
                            <option value="gps">GPS</option>
                        </select>
                    </div>
                </div>
                <details class="setting-item">
                    <summary>Customize Theme Intensity</summary>
                    <div class="slider-group-container">
                        <div class="slider-group"><div class="setting-label">Light Mode Glass</div><div class="setting-control"><div class="slider-wrapper"><input type="range" id="lightGlassIntensity" min="0.1" max="0.5" step="0.01" value="0.15"><div class="slider-labels"><span>Subtle</span><span>Default</span><span>Enchanted</span><span>Strong</span></div></div></div></div>
                        <div class="slider-group"><div class="setting-label">Dark Mode Glass</div><div class="setting-control"><div class="slider-wrapper"><input type="range" id="darkGlassIntensity" min="0.1" max="0.5" step="0.01" value="0.25"><div class="slider-labels"><span>Subtle</span><span>Default</span><span>Enchanted</span><span>Strong</span></div></div></div></div>
                        <div class="slider-group"><div class="setting-label">Blur Intensity</div><div class="setting-control"><div class="slider-wrapper"><input type="range" id="blurIntensity" min="5" max="30" step="1" value="15"><div class="slider-labels"><span>Subtle</span><span>Default</span><span>Enchanted</span><span>Strong</span></div></div></div></div>
                    </div>
                </details>
            </div>
            <div class="settings-group">
                <h3 class="group-title">Content Settings</h3>
                <div class="setting-item"><div class="setting-label">Content Type</div><div class="setting-control"><select id="subtitleContent"><option value="default">Default Text</option><option value="quran">Quranic Verse</option><option value="hadith">Hadith</option><option value="random" selected>Random</option></select></div></div>
                <div class="setting-item"><div class="setting-label">Language Display</div><div class="setting-control"><select id="languageDisplay"><option value="english">English</option><option value="arabic">Arabic</option><option value="both" selected>Both</option></select></div></div>
                <div class="setting-item"><div class="setting-label">Content Change Interval</div><div class="setting-control"><select id="contentInterval"><option value="30">30s</option><option value="60">1m</option><option value="300" selected>5m</option><option value="600">10m</option></select></div></div>
                <div class="setting-item"><div class="setting-label">Auto-Start Timer</div><div class="setting-control"><div class="checkbox-container"><input type="checkbox" id="autoStartTimer"><label class="checkbox-label" for="autoStartTimer"></label></div></div></div>
            </div>
            <div class="settings-group">
                <h3 class="group-title">Sound Settings</h3>
                <div class="setting-item">
                    <div class="setting-label">Chime Interval</div>
                    <div class="setting-control">
                        <select id="chimeIntervalSetting">
                            <option value="60">Every hour</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item" id="customChimeIntervalContainer" style="display: none;">
                    <div class="setting-label">Custom Minutes</div>
                    <div class="setting-control">
                        <input type="number" id="customChimeInterval" min="1" value="45">
                    </div>
                </div>
                <div class="setting-item"><div class="setting-label">Hourly Chime Sound</div><div class="setting-control"><select id="chimeSound"><option value="chime1">Soft Chime</option><option value="chime2">Bell Chime</option><option value="chime3">Nature Sound</option><option value="chime4">Airplane Noise</option><option value="chime5">Water Drops</option><option value="custom">Custom</option></select><button class="test-sound-btn" id="testChimeBtn"><i class="fas fa-play"></i></button></div></div>
                <div id="customChimeContainer" class="custom-file-container" style="display: none;"><label class="custom-file-label" for="customChime"><i class="fas fa-upload"></i> Upload Custom Chime</label><input type="file" id="customChime" accept="audio/*" style="display: none;"></div>
                <div class="setting-item"><div class="setting-label">Alarm Sound</div><div class="setting-control"><select id="alarmSound"><option value="alarm1">Digital Beep</option><option value="alarm2">Gentle Alarm</option><option value="alarm3">Birds Chirping</option><option value="alarm4">Quran Recitation</option><option value="alarm5">Ocean Waves</option><option value="custom">Custom</option></select><button class="test-sound-btn" id="testAlarmBtn"><i class="fas fa-play"></i></button></div></div>
                <div id="customAlarmContainer" class="custom-file-container" style="display: none;"><label class="custom-file-label" for="customAlarm"><i class="fas fa-upload"></i> Upload Custom Alarm</label><input type="file" id="customAlarm" accept="audio/*" style="display: none;"></div>
            </div>
            <div class="settings-group">
                <h3 class="group-title">Background Settings</h3>
                <div class="setting-item"><div class="setting-label">Background Change Interval</div><div class="setting-control"><select id="bgInterval"><option value="30">30s</option><option value="60">1m</option><option value="300">5m</option><option value="600" selected>10m</option><option value="custom">Custom</option></select></div></div>
                <div class="setting-item" id="customBgIntervalContainer" style="display: none;"><div class="setting-label">Custom Interval (s)</div><div class="setting-control"><input type="number" id="customBgInterval" min="5" value="45"></div></div>
                <div class="setting-item"><div class="setting-label">Image Transition</div><div class="setting-control"><select id="imageTransition"><option value="fade">Fade</option><option value="slide">Slide</option><option value="zoom">Zoom</option></select></div></div>
                <div class="setting-item"><div class="setting-label">Light Mode Subreddits</div><div class="subreddit-management"><div class="subreddit-list" id="lightSubredditList"></div><div class="add-subreddit"><input type="text" id="newLightSubreddit" placeholder="Add subreddit"><button id="addLightSubreddit">Add</button></div></div></div>
                <div class="setting-item"><div class="setting-label">Dark Mode Subreddits</div><div class="subreddit-management"><div class="subreddit-list" id="darkSubredditList"></div><div class="add-subreddit"><input type="text" id="newDarkSubreddit" placeholder="Add subreddit"><button id="addDarkSubreddit">Add</button></div></div></div>
            </div>
            <details class="setting-item">
                <summary>Advanced Information</summary>
                <div class="slider-group-container">
                     <div class="setting-item" style="background: transparent;">
                        <div class="setting-label">Sunrise Time:</div>
                        <div id="sunriseTime" class="setting-value">N/A</div>
                    </div>
                     <div class="setting-item" style="background: transparent;">
                        <div class="setting-label">Sunset Time:</div>
                        <div id="sunsetTime" class="setting-value">N/A</div>
                    </div>
                </div>
            </details>
            <div class="settings-group">
                <h3 class="group-title">Backup & Restore</h3>
                <div class="backup-buttons"><button class="backup-btn" id="backupBtn"><i class="fas fa-download"></i> Backup</button><button class="backup-btn" id="restoreBtn"><i class="fas fa-upload"></i> Restore</button><button class="backup-btn" id="resetSettingsBtn"><i class="fas fa-redo"></i> Reset</button></div>
                <input type="file" id="restoreFile" accept=".json" style="display: none;">
            </div>
            <div class="settings-footer"><button class="timer-btn" id="saveSettings" style="width: 100%;">Save Settings</button></div>
        </div>
    </div>
    
    <script>
        (function() {
            // DOM Elements
            const clockEl = document.getElementById('clock');
            const dateEl = document.getElementById('date');
            const islamicDateEl = document.getElementById('islamicDate');
            const backgroundEl = document.getElementById('background');
            const muteBtn = document.getElementById('muteBtn');
            const darkModeBtn = document.getElementById('darkModeBtn');
            const timerDisplay = document.getElementById('timerDisplay');
            const timerButtons = document.querySelectorAll('.timer-btn[data-minutes]');
            const toggleTimerBtn = document.getElementById('toggleTimerBtn');
            const resetBtn = document.getElementById('resetBtn');
            const toast = document.getElementById('toast');
            const subtitleEl = document.getElementById('subtitle');
            const footerEl = document.getElementById('footer');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettings = document.getElementById('closeSettings');
            const saveSettings = document.getElementById('saveSettings');
            const glassContainer = document.getElementById('glassContainer');
            const testChimeBtn = document.getElementById('testChimeBtn');
            const testAlarmBtn = document.getElementById('testAlarmBtn');
            const backupBtn = document.getElementById('backupBtn');
            const restoreBtn = document.getElementById('restoreBtn');
            const resetSettingsBtn = document.getElementById('resetSettingsBtn');
            const restoreFile = document.getElementById('restoreFile');
            const topControls = document.getElementById('topControls');
            const timerControls = document.getElementById('timerControls');
            const lightSubredditList = document.getElementById('lightSubredditList');
            const darkSubredditList = document.getElementById('darkSubredditList');
            const addLightSubreddit = document.getElementById('addLightSubreddit');
            const addDarkSubreddit = document.getElementById('addDarkSubreddit');
            const newLightSubreddit = document.getElementById('newLightSubreddit');
            const newDarkSubreddit = document.getElementById('newDarkSubreddit');
            const sunriseTimeEl = document.getElementById('sunriseTime');
            const sunsetTimeEl = document.getElementById('sunsetTime');
            
            // New Timer/Stopwatch Elements
            const customTimerContainer = document.getElementById('customTimerContainer');
            const customMinutesInput = document.getElementById('customMinutes');
            const stopwatchDisplay = document.getElementById('stopwatchDisplay');
            const stopwatchControlBtn = document.getElementById('stopwatchControlBtn'); // New button
            
            // Settings elements
            const showSeconds = document.getElementById('showSeconds');
            const showMilliseconds = document.getElementById('showMilliseconds');
            const showIslamicDate = document.getElementById('showIslamicDate');
            const showLoading = document.getElementById('showLoading');
            const showSources = document.getElementById('showSources');
            const arabicFontSelect = document.getElementById('arabicFont');
            const timeFormat = document.getElementById('timeFormat');
            const autoHideControls = document.getElementById('autoHideControls');
            const layoutMode = document.getElementById('layoutMode');
            const themeMode = document.getElementById('themeMode');
            const autoLocationMode = document.getElementById('autoLocationMode');
            const lightGlassIntensity = document.getElementById('lightGlassIntensity');
            const darkGlassIntensity = document.getElementById('darkGlassIntensity');
            const blurIntensity = document.getElementById('blurIntensity');
            const subtitleContent = document.getElementById('subtitleContent');
            const languageDisplay = document.getElementById('languageDisplay');
            const contentInterval = document.getElementById('contentInterval');
            const bgInterval = document.getElementById('bgInterval');
            const customBgIntervalContainer = document.getElementById('customBgIntervalContainer');
            const customBgInterval = document.getElementById('customBgInterval');
            const imageTransition = document.getElementById('imageTransition');
            const autoStartTimer = document.getElementById('autoStartTimer');
            const chimeSound = document.getElementById('chimeSound');
            const customChimeContainer = document.getElementById('customChimeContainer');
            const customChime = document.getElementById('customChime');
            const alarmSound = document.getElementById('alarmSound');
            const customAlarmContainer = document.getElementById('customAlarmContainer');
            const customAlarm = document.getElementById('customAlarm');
            const chimeIntervalSetting = document.getElementById('chimeIntervalSetting');
            const customChimeIntervalContainer = document.getElementById('customChimeIntervalContainer');
            const customChimeInterval = document.getElementById('customChimeInterval');
            
            // State Variables
            let isMuted = false, isDarkMode = true, timerInterval = null, timerDuration = 0, timerRemaining = 0, timerActive = false, lastChimeHour = -1, contentUpdateInterval = null, backgroundUpdateInterval = null, customChimeSound = null, customAlarmSound = null, activeSound = null, mouseIdleTimer = null, isMouseIdle = false;
            let lightSubreddits = ['EarthPorn', 'NaturePorn', 'LandscapePhotography'];
            let darkSubreddits = ['nightphotography', 'spaceporn', 'LandscapeAstro'];
            
            // New State Variables
            let stopwatchRunning = false, stopwatchStartTime = 0, stopwatchElapsed = 0, stopwatchInterval = null, currentMode = 'timer', chimeInterval = 60;
            

            const quranVerses = [
                { en: "Allah does not burden a soul beyond that it can bear.", ar: "لَا يُكَلِّفُ اللَّهُ نَفْسًا إِلَّا وُسْعَهَا", ref: "2:286", link: "https://quran.com/2/286", enSurah: "Al-Baqarah", arSurah: "البقرة" },
                { en: "And He is with you wherever you are.", ar: "وَهُوَ مَعَكُمْ أَيْنَ مَا كُنْتُمْ", ref: "57:4", link: "https://quran.com/57/4", enSurah: "Al-Hadid", arSurah: "الحديد" },
                { en: "Indeed, with hardship comes ease.", ar: "فَإِنَّ مَعَ الْعُسْرِ يُسْرًا", ref: "94:5", link: "https://quran.com/94/5", enSurah: "Ash-Sharh", arSurah: "الشرح" }
            ];
            const hadiths = [
                { 
                    en: "The best among you are those who have the best manners and character.", 
                    ar: "خِيَارُكُمْ أَحَاسِنُكُمْ أَخْلَاقًا", 
                    enRef: "Sahih Bukhari 3559", 
                    arRef: "صحيح البخاري 3559", // Added Arabic reference
                    link: "https://sunnah.com/bukhari:3559" 
                },
                { 
                    en: "Do not be angry.", 
                    ar: "لَا تَغْضَبْ", 
                    enRef: "Sahih Bukhari 6116", 
                    arRef: "صحيح البخاري 6116", // Added Arabic reference
                    link: "https://sunnah.com/bukhari:6116" 
                },
                { 
                    en: "The strong person is not the one who can wrestle, but the one who can control himself when angry.", 
                    ar: "لَيْسَ الشَّدِيدُ بِالصُّرَعَةِ، إِنَّمَا الشَّدِيدُ الَّذِي يَمْلِكُ نَفْسَهُ عِنْدَ الْغَضَبِ", 
                    enRef: "Sahih Muslim 2609", 
                    arRef: "صحيح مسلم 2609", // Added Arabic reference
                    link: "https://sunnah.com/muslim:2609" 
                }
            ];

            function getIslamicDate(date) {
                try {
                    const formatter = new Intl.DateTimeFormat('en-u-ca-islamic', { day: 'numeric', month: 'long', year: 'numeric' });
                    return formatter.format(date).replace(' AH', '') + ' AH';
                } catch (error) {
                    console.error('Error formatting Islamic date:', error);
                    return "Islamic date unavailable";
                }
            }
            
            function initSettings() {
                if (localStorage.getItem('themeMode') === null) themeMode.value = 'auto'; else if (localStorage.getItem('themeMode')) themeMode.value = localStorage.getItem('themeMode');
                if (localStorage.getItem('autoLocationMode') === null) autoLocationMode.value = 'ip'; else if (localStorage.getItem('autoLocationMode')) autoLocationMode.value = localStorage.getItem('autoLocationMode');
                if (localStorage.getItem('timeFormat') === null) timeFormat.value = '12h'; else if (localStorage.getItem('timeFormat')) timeFormat.value = localStorage.getItem('timeFormat');
                if (localStorage.getItem('subtitleContent') === null) subtitleContent.value = 'random'; else if (localStorage.getItem('subtitleContent')) subtitleContent.value = localStorage.getItem('subtitleContent');
                if (localStorage.getItem('languageDisplay') === null) languageDisplay.value = 'both'; else if (localStorage.getItem('languageDisplay')) languageDisplay.value = localStorage.getItem('languageDisplay');
                if (localStorage.getItem('contentInterval') === null) contentInterval.value = '300'; else if (localStorage.getItem('contentInterval')) contentInterval.value = localStorage.getItem('contentInterval');
                if (localStorage.getItem('bgInterval') === null) bgInterval.value = '600'; else if (localStorage.getItem('bgInterval')) bgInterval.value = localStorage.getItem('bgInterval');
                showSeconds.checked = localStorage.getItem('showSeconds') === 'true';
                showMilliseconds.checked = localStorage.getItem('showMilliseconds') === 'true';
                showIslamicDate.checked = localStorage.getItem('showIslamicDate') !== 'false';
                showLoading.checked = localStorage.getItem('showLoading') === 'true';
                showSources.checked = localStorage.getItem('showSources') === 'true';
                footerEl.style.display = showSources.checked ? 'block' : 'none';
                const savedFont = localStorage.getItem('arabicFont') || "'Amiri', serif";
                document.documentElement.style.setProperty('--arabic-font', savedFont);
                arabicFontSelect.value = savedFont;
                arabicFontSelect.addEventListener('change', e => { const newFont = e.target.value; document.documentElement.style.setProperty('--arabic-font', newFont); localStorage.setItem('arabicFont', newFont); if (typeof showToast === 'function') showToast(`Arabic font changed to ${arabicFontSelect.selectedOptions[0].text}`); });
                if (localStorage.getItem('autoHideControls') !== null) autoHideControls.checked = localStorage.getItem('autoHideControls') === 'true';
                if (localStorage.getItem('layoutMode')) { layoutMode.value = localStorage.getItem('layoutMode'); applyLayoutMode(); }
                if (localStorage.getItem('lightGlassIntensity')) lightGlassIntensity.value = localStorage.getItem('lightGlassIntensity');
                if (localStorage.getItem('darkGlassIntensity')) darkGlassIntensity.value = localStorage.getItem('darkGlassIntensity');
                if (localStorage.getItem('blurIntensity')) { blurIntensity.value = localStorage.getItem('blurIntensity'); applyBlurEffect(); }
                if (localStorage.getItem('customBgInterval')) customBgInterval.value = localStorage.getItem('customBgInterval');
                if (localStorage.getItem('imageTransition')) imageTransition.value = localStorage.getItem('imageTransition');
                if (localStorage.getItem('autoStartTimer') !== null) autoStartTimer.checked = localStorage.getItem('autoStartTimer') === 'true';
                if (localStorage.getItem('chimeSound')) { chimeSound.value = localStorage.getItem('chimeSound'); toggleCustomChime(); }
                if (localStorage.getItem('alarmSound')) { alarmSound.value = localStorage.getItem('alarmSound'); toggleCustomAlarm(); }
                if (localStorage.getItem('lightSubreddits')) lightSubreddits = JSON.parse(localStorage.getItem('lightSubreddits'));
                if (localStorage.getItem('darkSubreddits')) darkSubreddits = JSON.parse(localStorage.getItem('darkSubreddits'));
                
                // Init new chime settings
                if (localStorage.getItem('chimeIntervalSetting')) {
                    chimeIntervalSetting.value = localStorage.getItem('chimeIntervalSetting');
                    chimeInterval = parseInt(localStorage.getItem('chimeInterval'));
                    if (chimeIntervalSetting.value === 'custom') {
                        customChimeIntervalContainer.style.display = 'flex';
                        customChimeInterval.value = chimeInterval;
                    }
                }
                
                setThemeMode();
                updateSubtitleContent(); updateSubredditLists(); toggleCustomBgInterval();
            }

            function saveSettingsToStorage() {
                const settings = {
                    themeMode: themeMode.value, autoLocationMode: autoLocationMode.value,
                    showSeconds: showSeconds.checked, showMilliseconds: showMilliseconds.checked, showIslamicDate: showIslamicDate.checked, showLoading: showLoading.checked, showSources: showSources.checked, timeFormat: timeFormat.value, autoHideControls: autoHideControls.checked, layoutMode: layoutMode.value, lightGlassIntensity: lightGlassIntensity.value, darkGlassIntensity: darkGlassIntensity.value, blurIntensity: blurIntensity.value, subtitleContent: subtitleContent.value, languageDisplay: languageDisplay.value, contentInterval: contentInterval.value, bgInterval: bgInterval.value, customBgInterval: customBgInterval.value, imageTransition: imageTransition.value, autoStartTimer: autoStartTimer.checked, chimeSound: chimeSound.value, alarmSound: alarmSound.value, lightSubreddits, darkSubreddits,
                    chimeInterval: chimeInterval, chimeIntervalSetting: chimeIntervalSetting.value
                };
                for (const key in settings) { localStorage.setItem(key, typeof settings[key] === 'object' ? JSON.stringify(settings[key]) : settings[key]); }
                showToast("Settings saved successfully!");
            }

            function applyLayoutMode() {
                const mode = layoutMode.value;
                glassContainer.classList.toggle('auto-layout', mode === 'auto');
                if (mode === 'auto') { glassContainer.style.maxWidth = ''; } else if (mode === 'landscape') { glassContainer.style.maxWidth = '800px'; } else if (mode === 'portrait') { glassContainer.style.maxWidth = '550px'; }
            }
            
            function updateSunriseSunsetDisplay(sunrise, sunset) {
                const formatTime = (date) => date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                sunriseTimeEl.textContent = sunrise ? formatTime(sunrise) : 'N/A';
                sunsetTimeEl.textContent = sunset ? formatTime(sunset) : 'N/A';
            }

            async function getCoords(source) {
                if (source === 'gps') {
                    const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 }));
                    return { latitude: position.coords.latitude, longitude: position.coords.longitude };
                }
                if (source === 'ip') {
                    const response = await fetch('https://ipapi.co/json/');
                    if (!response.ok) throw new Error('IP API request failed');
                    const data = await response.json();
                    return { latitude: data.latitude, longitude: data.longitude };
                }
                throw new Error('Invalid location source');
            }

            async function updateAutoTheme() {
                const source = autoLocationMode.value;
                try {
                    if (source === 'basic') {
                        const nowHour = new Date().getHours();
                        isDarkMode = nowHour < 6 || nowHour >= 18;
                        const now = new Date(); const sunrise = new Date(now); sunrise.setHours(6, 0, 0, 0); const sunset = new Date(now); sunset.setHours(18, 0, 0, 0);
                        updateSunriseSunsetDisplay(sunrise, sunset);
                    } else {
                        const { latitude, longitude } = await getCoords(source);
                        const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${latitude}&lng=${longitude}&formatted=0`);
                        const data = await response.json();
                        if (data.status !== 'OK') throw new Error('Sunrise/Sunset API Error');
                        const sunrise = new Date(data.results.sunrise); const sunset = new Date(data.results.sunset); const now = new Date();
                        isDarkMode = now < sunrise || now > sunset;
                        updateSunriseSunsetDisplay(sunrise, sunset);
                    }
                } catch (error) {
                    console.error(`Auto theme update failed for source "${source}":`, error);
                    showToast(`Auto mode failed. Falling back to system theme.`);
                    isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    updateSunriseSunsetDisplay(null, null);
                }
                const themeChanged = document.body.classList.contains('dark-mode') !== isDarkMode;
                document.body.className = isDarkMode ? 'dark-mode' : '';
                if (themeChanged) fetchRedditBackground();
            }

            function updateDarkModeIcon() {
                const currentMode = themeMode.value;
                if (currentMode === 'dark') { darkModeBtn.innerHTML = '<i class="fas fa-moon"></i>'; } else if (currentMode === 'light') { darkModeBtn.innerHTML = '<i class="fas fa-sun"></i>'; } else { darkModeBtn.innerHTML = '<span class="auto-mode-icon">A</span>'; }
            }

            function setThemeMode() {
                updateDarkModeIcon();
                if (themeMode.value === 'auto') { updateAutoTheme(); } else { const newIsDarkMode = themeMode.value === 'dark'; const themeChanged = isDarkMode !== newIsDarkMode; isDarkMode = newIsDarkMode; document.body.className = isDarkMode ? 'dark-mode' : ''; if (themeChanged) fetchRedditBackground(); }
            }

            function applyBlurEffect() { backgroundEl.style.filter = `blur(${blurIntensity.value}px) brightness(0.8)`; }
            
            async function updateSubtitleContent() {
                const type = subtitleContent.value;
                const lang = languageDisplay.value;
                subtitleEl.innerHTML = '<span class="spinner"></span>';
                try {
                    let content;
                    if (type === 'quran' || (type === 'random' && Math.random() > 0.5)) {
                        let attempts = 0;
                        while (attempts < 5) {
                            const randomVerse = Math.floor(Math.random() * 6236) + 1;
                            const response = await fetch(`https://api.alquran.cloud/v1/ayah/${randomVerse}/editions/quran-uthmani,en.sahih`);
                            const data = await response.json();
                            const arabicText = data.data[0].text;
                            const wordCount = arabicText.trim().split(/\s+/).length;
                            if (wordCount < 20) {
                                content = { ar: arabicText, en: data.data[1].text, ref: `${data.data[0].surah.number}:${data.data[0].numberInSurah}`, link: `https://quran.com/${data.data[0].surah.number}/${data.data[0].numberInSurah}`, arSurah: data.data[0].surah.name, enSurah: data.data[0].surah.englishName };
                                break;
                            }
                            attempts++;
                        }
                        if (!content) { content = quranVerses[Math.floor(Math.random() * quranVerses.length)]; }
                    } else if (type === 'hadith' || type === 'random') {
                        content = hadiths[Math.floor(Math.random() * hadiths.length)];
                    }
                    if (!content) { subtitleEl.textContent = "Relaxing backgrounds from Earth's beauty"; return; }
                    displayContent(content, lang);
                } catch (error) {
                    console.error("Failed to fetch new content:", error);
                    subtitleEl.textContent = "Could not load content. Please try again later.";
                }
            }

            function displayContent(content, lang) {
                subtitleEl.innerHTML = ''; 
                const container = document.createElement('div'); 
                container.style.textAlign = 'center';
                
                if (lang === 'arabic' || lang === 'both') {
                    const arabicEl = document.createElement('div'); 
                    arabicEl.className = 'arabic-text';
                    if (content.enSurah) { 
                        // Quranic verse - remove symbol before display
                        const verseNum = content.ref.split(':')[1];
                        const cleanArabic = content.ar.replace(/۞/g, '');
                        arabicEl.innerHTML = `${cleanArabic} <a class="content-ref" href="${content.link}" target="_blank">${content.arSurah} ${verseNum}</a>`;
                    } else { 
                        // Hadith - use Arabic reference
                        arabicEl.innerHTML = `${content.ar} <a class="content-ref" href="${content.link}" target="_blank">${content.arRef}</a>`;
                    }
                    container.appendChild(arabicEl);
                }
                
                if (lang === 'english' || lang === 'both') {
                    const englishEl = document.createElement('div');
                    if (content.enSurah) { 
                        const verseNum = content.ref.split(':')[1];
                        englishEl.innerHTML = `${content.en} <a class="content-ref" href="${content.link}" target="_blank">${content.enSurah} ${verseNum}</a>`;
                    } else { 
                        // Hadith - use English reference
                        englishEl.innerHTML = `${content.en} <a class="content-ref" href="${content.link}" target="_blank">${content.enRef}</a>`;
                    }
                    container.appendChild(englishEl);
                }
                
                subtitleEl.appendChild(container);
            }

            function updateSubredditLists() { lightSubredditList.innerHTML = ''; darkSubredditList.innerHTML = ''; lightSubreddits.forEach(sub => createSubredditItem(sub, lightSubredditList, lightSubreddits)); darkSubreddits.forEach(sub => createSubredditItem(sub, darkSubredditList, darkSubreddits)); }
            function createSubredditItem(subreddit, listElement, subredditArray) { const item = document.createElement('div'); item.className = 'subreddit-item'; item.innerHTML = `<span class="subreddit-name">${subreddit}</span><button class="remove-subreddit">×</button>`; item.querySelector('.remove-subreddit').addEventListener('click', () => { const index = subredditArray.indexOf(subreddit); if (index > -1) subredditArray.splice(index, 1); updateSubredditLists(); }); listElement.appendChild(item); }
            function toggleCustomBgInterval() { customBgIntervalContainer.style.display = bgInterval.value === 'custom' ? 'flex' : 'none'; }
            function toggleCustomChime() { customChimeContainer.style.display = chimeSound.value === 'custom' ? 'block' : 'none'; }
            function toggleCustomAlarm() { customAlarmContainer.style.display = alarmSound.value === 'custom' ? 'block' : 'none'; }
            function stopActiveSound() { if (activeSound) { activeSound.pause(); activeSound.currentTime = 0; activeSound = null; } }
            
            function updateClock() {
                const now = new Date();
                let hours = now.getHours(); const minutes = String(now.getMinutes()).padStart(2, '0'); const seconds = String(now.getSeconds()).padStart(2, '0'); let ampm = '';
                if (timeFormat.value === '12h') { ampm = hours >= 12 ? ' PM' : ' AM'; hours = hours % 12 || 12; }
                hours = String(hours).padStart(2, '0');
                clockEl.textContent = showSeconds.checked ? `${hours}:${minutes}:${seconds}${ampm}` : `${hours}:${minutes}${ampm}`;
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateEl.textContent = now.toLocaleDateString('en-US', options);
                if (showIslamicDate.checked && islamicDateEl) { islamicDateEl.textContent = getIslamicDate(now); islamicDateEl.style.display = 'block'; } else if(islamicDateEl) { islamicDateEl.style.display = 'none'; }
                if (now.getMinutes() % chimeInterval === 0 && now.getSeconds() === 0) { playChime(); }
            }
            
            function playSound(type, soundProfile) { if (isMuted) return; stopActiveSound(); const customSound = type === 'chime' ? customChimeSound : customAlarmSound; const soundValue = type === 'chime' ? chimeSound.value : alarmSound.value; if (soundValue === 'custom' && customSound) { activeSound = customSound.cloneNode(); activeSound.play(); return; } const AudioContext = window.AudioContext || window.webkitAudioContext; const audioCtx = new AudioContext(); const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); const profile = soundProfile[soundValue]; if (!profile) return; oscillator.type = profile.type; oscillator.frequency.setValueAtTime(profile.freq, audioCtx.currentTime); if (profile.freqEnd) oscillator.frequency.linearRampToValueAtTime(profile.freqEnd, audioCtx.currentTime + profile.rampTime); gainNode.gain.setValueAtTime(profile.gain, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + profile.duration); oscillator.start(); oscillator.stop(audioCtx.currentTime + profile.duration); }
            const chimeSounds = { 'chime1': { type: 'sine', freq: 880, gain: 0.2, duration: 1 }, 'chime2': { type: 'triangle', freq: 1046.50, gain: 0.3, duration: 1.5 }, 'chime3': { type: 'sine', freq: 1500, freqEnd: 2500, rampTime: 0.2, gain: 0.2, duration: 0.5 }, 'chime4': { type: 'sawtooth', freq: 120, gain: 0.1, duration: 2 }, 'chime5': { type: 'triangle', freq: 3000, gain: 0.15, duration: 0.3 } };
            const alarmSounds = { 'alarm1': { type: 'square', freq: 1000, gain: 0.2, duration: 1 }, 'alarm2': { type: 'sine', freq: 440, freqEnd: 880, rampTime: 0.5, gain: 0.25, duration: 1.5 }, 'alarm3': { type: 'sine', freq: 2000, freqEnd: 3000, rampTime: 0.3, gain: 0.2, duration: 0.5 }, 'alarm4': { type: 'sawtooth', freq: 300, gain: 0.1, duration: 2 }, 'alarm5': { type: 'triangle', freq: 100, gain: 0.15, duration: 2 } };
            
            function playChime() { if (showLoading.checked) { const now = new Date(); const hours = now.getHours(); const minutes = now.getMinutes(); showToast(`It's ${hours}:${String(minutes).padStart(2, '0')}! Chime playing...`); } playSound('chime', chimeSounds); }
            function playCompletionSound() { playSound('alarm', alarmSounds); }
            function testChime() { playChime(); }
            function testAlarm() { playCompletionSound(); }
            function toggleMute() { isMuted = !isMuted; muteBtn.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>'; showToast(isMuted ? 'Sound muted' : 'Sound enabled'); }
            
            function startTimer() { if (timerRemaining <= 0 || timerActive) return; timerActive = true; toggleTimerBtn.innerHTML = '<i class="fas fa-pause"></i>'; timerInterval = setInterval(() => { timerRemaining--; if (timerRemaining <= 0) { clearInterval(timerInterval); timerActive = false; showToast("Timer completed!"); if (!isMuted) playCompletionSound(); timerDisplay.textContent = "00:00"; toggleTimerBtn.innerHTML = '<i class="fas fa-play"></i>'; return; } updateTimerDisplay(); }, 1000); }
            function pauseTimer() { if (!timerActive) return; clearInterval(timerInterval); timerActive = false; toggleTimerBtn.innerHTML = '<i class="fas fa-play"></i>'; showToast("Timer paused"); }
            function resetTimer() { pauseTimer(); timerRemaining = timerDuration; updateTimerDisplay(); toggleTimerBtn.innerHTML = '<i class="fas fa-play"></i>'; showToast("Timer reset"); }
            
            function updateTimerDisplay() {
                if (isNaN(timerRemaining)) timerRemaining = 0;
                const totalMinutes = Math.floor(timerDuration / 60);
                if (timerActive) {
                    const hours = Math.floor(timerRemaining / 3600);
                    const minutes = Math.floor((timerRemaining % 3600) / 60);
                    const seconds = timerRemaining % 60;
                    if (hours > 0) { timerDisplay.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; } 
                    else { timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
                } else {
                    if (totalMinutes >= 60) {
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        timerDisplay.textContent = `${hours}H ${String(minutes).padStart(2, '0')}M`;
                    } else {
                        timerDisplay.textContent = `${String(totalMinutes).padStart(2, '0')}:00`;
                    }
                }
            }

            function setTimer(minutes, isAutoStart = false, notify = true) {
                minutes = parseInt(minutes); if (isNaN(minutes)) { minutes = 5; }
                timerDuration = minutes * 60; timerRemaining = timerDuration; updateTimerDisplay(); toggleTimerBtn.innerHTML = '<i class="fas fa-play"></i>';
                if (notify) { showToast(`Timer set to ${minutes} minutes`); }
                if (isAutoStart && autoStartTimer.checked) { startTimer(); }
            }

            function setCustomTimer() {
                const minutes = parseInt(customMinutesInput.value);
                if (minutes && minutes > 0) {
                    setTimer(minutes, true);
                    customTimerContainer.classList.remove('expanded');
                    customMinutesInput.value = '';
                }
            }
            
            // Stopwatch Functions
            function toggleStopwatch() {
                if (currentMode === 'timer') {
                    // Switch to stopwatch mode
                    currentMode = 'stopwatch';
                    timerDisplay.style.display = 'none';
                    stopwatchDisplay.style.display = 'block';
                    
                    // Update the play/pause button to reflect the stopwatch's current state
                    toggleTimerBtn.innerHTML = stopwatchRunning ? 
                        '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
                } else {
                    // Switch to timer mode
                    currentMode = 'timer';
                    timerDisplay.style.display = 'block';
                    stopwatchDisplay.style.display = 'none';
                    
                    // Update the play/pause button to reflect the timer's current state
                    toggleTimerBtn.innerHTML = timerActive ? 
                        '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
                }
                
                // Update the active state highlight on the stopwatch/timer toggle button
                stopwatchControlBtn.classList.toggle('active', currentMode === 'stopwatch');
            }


            function startStopwatch() { if (!stopwatchRunning) { stopwatchStartTime = Date.now() - stopwatchElapsed; stopwatchInterval = setInterval(updateStopwatchDisplay, 10); stopwatchRunning = true; toggleTimerBtn.innerHTML = '<i class="fas fa-pause"></i>'; } }
            function pauseStopwatch() { if (stopwatchRunning) { clearInterval(stopwatchInterval); stopwatchElapsed = Date.now() - stopwatchStartTime; stopwatchRunning = false; toggleTimerBtn.innerHTML = '<i class="fas fa-play"></i>'; } }
            function resetStopwatch() { pauseStopwatch(); stopwatchElapsed = 0; updateStopwatchDisplay(); }
            
            function updateStopwatchDisplay() {
                const elapsed = stopwatchRunning ? Date.now() - stopwatchStartTime : stopwatchElapsed;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                let displayHTML = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                if (showMilliseconds.checked) {
                    const milliseconds = Math.floor((elapsed % 1000) / 10);
                    displayHTML += `<span class="milliseconds">${String(milliseconds).padStart(2, '0')}</span>`;
                }

                stopwatchDisplay.innerHTML = displayHTML;
            }

            function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
            function preloadBackground(url, callback) { const img = new Image(); img.onload = () => callback(url); img.onerror = () => { console.error('Error preloading image:', url); callback('https://images.unsplash.com/photo-1506744038136-46273834b3fb'); }; img.src = url; }
            async function fetchRedditBackground() { try { const subreddits = isDarkMode ? darkSubreddits : lightSubreddits; if (showLoading.checked) timerDisplay.innerHTML = '<span class="spinner"></span> Loading image...'; const randomSubreddit = subreddits[Math.floor(Math.random() * subreddits.length)]; const response = await fetch(`https://www.reddit.com/r/${randomSubreddit}/top.json?limit=20&t=day`); const data = await response.json(); const postsWithImages = data.data.children.filter(p => p.data.post_hint === 'image' && p.data.url.match(/\.(jpeg|jpg|png)$/)); if (postsWithImages.length === 0) throw new Error('No images found'); const randomPost = postsWithImages[Math.floor(Math.random() * postsWithImages.length)]; preloadBackground(randomPost.data.url, url => { backgroundEl.style.opacity = 0; setTimeout(() => { backgroundEl.style.backgroundImage = `url('${url}')`; backgroundEl.className = 'background'; void backgroundEl.offsetWidth; backgroundEl.classList.add(`transition-${imageTransition.value}`); backgroundEl.style.opacity = 1; }, 500); if (currentMode === 'timer' && timerRemaining <= 0) timerDisplay.textContent = "Set a timer"; else if (currentMode === 'timer') updateTimerDisplay(); if (showLoading.checked) showToast(`New background from r/${randomSubreddit}`); }); } catch (error) { console.error('Error fetching from Reddit:', error); backgroundEl.style.backgroundImage = "url('https://images.unsplash.com/photo-1506744038136-46273834b3fb')"; if (showLoading.checked) showToast("Using default image"); if (currentMode === 'timer' && timerRemaining <= 0) timerDisplay.textContent = "Set a timer"; else if (currentMode === 'timer') updateTimerDisplay(); } }
            function backupSettings() { const settings = { themeMode: themeMode.value, autoLocationMode: autoLocationMode.value, showSeconds: showSeconds.checked, showMilliseconds: showMilliseconds.checked, showIslamicDate: showIslamicDate.checked, showLoading: showLoading.checked, showSources: showSources.checked, timeFormat: timeFormat.value, autoHideControls: autoHideControls.checked, layoutMode: layoutMode.value, lightGlassIntensity: lightGlassIntensity.value, darkGlassIntensity: darkGlassIntensity.value, blurIntensity: blurIntensity.value, subtitleContent: subtitleContent.value, languageDisplay: languageDisplay.value, contentInterval: contentInterval.value, bgInterval: bgInterval.value, customBgInterval: customBgInterval.value, imageTransition: imageTransition.value, autoStartTimer: autoStartTimer.checked, chimeSound: chimeSound.value, alarmSound: alarmSound.value, lightSubreddits, darkSubreddits, chimeInterval, chimeIntervalSetting: chimeIntervalSetting.value }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(settings, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "nature-clock-settings.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showToast("Settings backup downloaded!"); }
            function restoreSettings() { restoreFile.click(); }
            function resetAllSettings() { if (confirm("Are you sure you want to reset all settings to default?")) { localStorage.clear(); location.reload(); } }
            function resetMouseIdleTimer() { clearTimeout(mouseIdleTimer); if (autoHideControls.checked) { topControls.style.opacity = '1'; timerControls.style.opacity = '1'; mouseIdleTimer = setTimeout(() => { topControls.style.opacity = '0'; timerControls.style.opacity = '0'; isMouseIdle = true; }, 5000); } }
            function setupSliderSnapping() { const sliders = { lightGlassIntensity: { points: [0.1, 0.25, 0.35, 0.5], tolerance: 0.04 }, darkGlassIntensity: { points: [0.1, 0.25, 0.35, 0.5], tolerance: 0.04 }, blurIntensity: { points: [5, 12, 20, 30], tolerance: 2 } }; for (const id in sliders) { const slider = document.getElementById(id); if (slider) { const { points, tolerance } = sliders[id]; const snapFunction = () => { const currentValue = parseFloat(slider.value); for (const point of points) { if (Math.abs(currentValue - point) < tolerance) { if (slider.value !== String(point)) { slider.value = point; } return; } } }; slider.addEventListener('input', snapFunction); } } }
            
            function handleResize() { if (layoutMode.value === 'auto') { applyLayoutMode(); } }

            function addEventListeners() { 
                muteBtn.addEventListener('click', toggleMute); 
                darkModeBtn.addEventListener('click', () => { const currentMode = themeMode.value; if (currentMode === 'dark') themeMode.value = 'light'; else if (currentMode === 'light') themeMode.value = 'auto'; else themeMode.value = 'dark'; setThemeMode(); saveSettingsToStorage(); });
                
                // Combined play/pause button
                toggleTimerBtn.addEventListener('click', () => {
                    if (currentMode === 'timer') {
                        if (timerActive) pauseTimer(); else startTimer();
                    } else {
                        if (stopwatchRunning) pauseStopwatch(); else startStopwatch();
                    }
                });

                // Reset button
                resetBtn.addEventListener('click', () => {
                    if (currentMode === 'timer') resetTimer(); else resetStopwatch();
                });
                
                timerButtons.forEach(button => { button.addEventListener('click', () => { setTimer(button.getAttribute('data-minutes'), true); }); });
                
                // Custom Timer Input Listeners
                customTimerContainer.addEventListener('click', function(e) { if (!this.classList.contains('expanded')) { this.classList.add('expanded'); setTimeout(() => customMinutesInput.focus(), 300); e.stopPropagation(); } });
                
                // UPDATED: JavaScript Collapse Handler
                document.addEventListener('click', function(e) {
                    const customTimer = document.getElementById('customTimerContainer');
                    if (customTimer.classList.contains('expanded') && 
                        !customTimer.contains(e.target) && 
                        e.target !== customTimer) {
                        customTimer.classList.remove('expanded');
                    }
                });

                customMinutesInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { setCustomTimer(); } });
                
                // Stopwatch Toggle Listener
                stopwatchControlBtn.addEventListener('click', toggleStopwatch);

                settingsBtn.addEventListener('click', () => settingsModal.classList.add('active')); 
                closeSettings.addEventListener('click', () => { stopActiveSound(); settingsModal.classList.remove('active'); }); 
                saveSettings.addEventListener('click', () => { stopActiveSound(); saveSettingsToStorage(); applyLayoutMode(); setThemeMode(); applyBlurEffect(); footerEl.style.display = showSources.checked ? 'block' : 'none'; updateSubtitleContent(); setupContentUpdate(); setupBackgroundUpdate(); settingsModal.classList.remove('active'); }); 
                testChimeBtn.addEventListener('click', testChime); testAlarmBtn.addEventListener('click', testAlarm); 
                customChime.addEventListener('change', e => { if (e.target.files[0]) customChimeSound = new Audio(URL.createObjectURL(e.target.files[0])); }); 
                customAlarm.addEventListener('change', e => { if (e.target.files[0]) customAlarmSound = new Audio(URL.createObjectURL(e.target.files[0])); }); 
                backupBtn.addEventListener('click', backupSettings); restoreBtn.addEventListener('click', restoreSettings); resetSettingsBtn.addEventListener('click', resetAllSettings); 
                restoreFile.addEventListener('change', e => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = e => { try { const s = JSON.parse(e.target.result); Object.keys(s).forEach(key => { if (key === 'lightSubreddits' || key === 'darkSubreddits') window[key] = s[key]; else if (document.getElementById(key)) { if(document.getElementById(key).type === 'checkbox') document.getElementById(key).checked = s[key]; else document.getElementById(key).value = s[key]; }}); toggleCustomChime(); toggleCustomAlarm(); updateSubredditLists(); toggleCustomBgInterval(); showToast("Settings restored!"); } catch (error) { showToast("Invalid settings file."); console.error(error); } }; reader.readAsText(e.target.files[0]); } }); 
                addLightSubreddit.addEventListener('click', () => { const sub = newLightSubreddit.value.trim(); if (sub && !lightSubreddits.includes(sub)) { lightSubreddits.push(sub); updateSubredditLists(); newLightSubreddit.value = ''; } }); 
                addDarkSubreddit.addEventListener('click', () => { const sub = newDarkSubreddit.value.trim(); if (sub && !darkSubreddits.includes(sub)) { darkSubreddits.push(sub); updateSubredditLists(); newDarkSubreddit.value = ''; } }); 
                chimeSound.addEventListener('change', toggleCustomChime); alarmSound.addEventListener('change', toggleCustomAlarm); bgInterval.addEventListener('change', toggleCustomBgInterval); 
                document.addEventListener('mousemove', () => { if (isMouseIdle) { topControls.style.opacity = '1'; timerControls.style.opacity = '1'; isMouseIdle = false; } resetMouseIdleTimer(); }); 
                window.addEventListener('resize', () => { if (layoutMode.value === 'auto') applyLayoutMode(); }); 
                
                // Chime interval setting listener
                chimeIntervalSetting.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customChimeIntervalContainer.style.display = 'flex';
                        chimeInterval = parseInt(customChimeInterval.value) || 45;
                    } else {
                        customChimeIntervalContainer.style.display = 'none';
                        chimeInterval = parseInt(this.value);
                    }
                });
                customChimeInterval.addEventListener('change', function() {
                    chimeInterval = parseInt(this.value) || 45;
                });
            }
            function setupBackgroundUpdate() { clearInterval(backgroundUpdateInterval); let interval = bgInterval.value === 'custom' ? parseInt(customBgInterval.value) * 1000 : parseInt(bgInterval.value) * 1000; backgroundUpdateInterval = setInterval(fetchRedditBackground, interval); }
            function setupContentUpdate() { clearInterval(contentUpdateInterval); contentUpdateInterval = setInterval(updateSubtitleContent, parseInt(contentInterval.value) * 1000); }
            function init() { 
                addEventListeners(); 
                initSettings(); 
                updateClock(); 
                updateDarkModeIcon();
                setInterval(updateClock, 1000); 
                fetchRedditBackground(); 
                setupBackgroundUpdate(); 
                setupContentUpdate(); 
                setTimer(5, false, false); 
                resetMouseIdleTimer(); 
                setupSliderSnapping(); 
                applyLayoutMode();
                window.addEventListener('resize', handleResize);
                setInterval(() => { if (themeMode.value === 'auto') { updateAutoTheme(); } }, 600000);
                stopwatchControlBtn.classList.remove('active');
            }
            window.addEventListener('load', init);
        })();
    </script>
</body>
</html>